{% extends 'shop/base.html' %}
{% load static %}

{% block content %}

<style>
/* ===== PAGE LAYOUT ===== */
.product-page {
  display: grid;
  grid-template-columns: 420px 1fr;
  gap: 48px;
  margin-top: 30px;
}

@media (max-width: 900px) {
  .product-page {
    grid-template-columns: 1fr;
  }
}

/* ===== IMAGE ===== */
.product-media img {
  width: 100%;
  border-radius: 16px;
  background: #fff;
  box-shadow: 0 14px 40px rgba(0,0,0,.15);
}

/* ===== INFO ===== */
.product-info {
  max-width: 560px;
}

.product-info h1 {
  font-size: 30px;
  font-weight: 900;
  margin-bottom: 6px;
}

.muted {
  color: #6b7280;
}

.small {
  font-size: 14px;
}

/* ===== PRICE ===== */
.price-row {
  display: flex;
  align-items: center;
  gap: 14px;
  margin: 20px 0;
}

.price-big {
  font-size: 32px;
  font-weight: 900;
  color: #111827;
}

.strike {
  text-decoration: line-through;
  color: #9ca3af;
  font-size: 16px;
}

.discount-badge {
  background: #fee2e2;
  color: #b91c1c;
  padding: 6px 12px;
  border-radius: 999px;
  font-weight: 800;
  font-size: 13px;
}

/* ===== DESCRIPTION ===== */
.desc {
  margin: 16px 0;
  line-height: 1.6;
  color: #374151;
}

/* ===== FORM ===== */
.field {
  margin-bottom: 18px;
}

.field label {
  font-weight: 700;
  font-size: 14px;
  margin-bottom: 6px;
  display: block;
}

.field input,
.field select {
  width: 100%;
  padding: 11px 14px;
  border-radius: 12px;
  border: 1px solid #d1d5db;
  font-size: 15px;
  background: #fff;
}

/* ===== BUTTONS ===== */
.btn {
  padding: 12px 22px;
  border-radius: 14px;
  font-weight: 800;
  cursor: pointer;
  border: none;
  transition: all .2s ease;
}

.btn-primary {
  background: linear-gradient(135deg,#111,#333);
  color: #fff;
}

.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 8px 18px rgba(0,0,0,.25);
}

.btn-outline {
  border: 1px solid #d1d5db;
  background: #fff;
}

/* ===== PRICE ALERT ===== */
.alert-box {
  margin-top: 26px;
  background: #f9fafb;
  border: 1px dashed #d1d5db;
  padding: 14px;
  border-radius: 14px;
  font-size: 14px;
}

/* ===== RECOMMENDATIONS ===== */
.reco-section {
  margin-top: 60px;
}

.reco-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill,minmax(180px,1fr));
  gap: 20px;
  margin-top: 16px;
}

.reco-card {
  background: #fff;
  border-radius: 14px;
  padding: 14px;
  box-shadow: 0 8px 20px rgba(0,0,0,.1);
  transition: transform .2s ease;
}

.reco-card:hover {
  transform: translateY(-4px);
}

.reco-card img {
  width: 100%;
  height: 150px;
  object-fit: contain;
  margin-bottom: 10px;
}

.reco-name {
  font-weight: 700;
  margin-bottom: 4px;
}

.reco-price {
  font-weight: 900;
  margin-bottom: 10px;
}
/* ===== INLINE FIELD ROW ===== */
.inline-fields {
  display: flex;
  gap: 16px;
  align-items: flex-end;
  margin-bottom: 18px;
}

.inline-fields .field {
  margin-bottom: 0;
}

/* Small input boxes */
.inline-fields input,
.inline-fields select {
  width: 160px;       /* üëà smaller width */
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid #d1d5db;
  font-size: 14px;
}
.review-section {
background: #fff;
padding: 30px;
border-radius: 12px;
margin-top: 40px;
}

/* TOP GRID */
.review-header {
display: grid;
grid-template-columns: 220px 1fr;
gap: 40px;
align-items: start;
}

/* LEFT */
.avg-box {
text-align: left;
}

.avg-score {
font-size: 28px;
font-weight: 800;
}

.avg-stars {
color: #f59e0b;
font-size: 20px;
margin: 6px 0;
}

.total-reviews {
font-size: 14px;
color: #555;
}

/* RIGHT */
.review-bars {
width: 100%;
}

.bar-row {
display: grid;
grid-template-columns: 60px 1fr 50px;
align-items: center;
gap: 12px;
margin-bottom: 10px;
}

.star-label {
font-size: 14px;
}

.bar {
height: 12px;
background: #e5e7eb;
border-radius: 6px;
overflow: hidden;
}

.bar-fill {
height: 100%;
background: #f59e0b;
}

.percent {
font-size: 13px;
color: #333;
}

/* FORM */
.review-form {
margin-top: 30px;


}

.rating-input label {
font-size: 20px;
color: #f59e0b;
cursor: pointer;
}

.rating-input input {
display: none;
}

.review-form textarea {
width: 200%;
height: 90px;
margin-top: 10px;
padding: 10px;
}

.review-form button {
margin-top: 10px;
padding: 10px 18px;
background: #111;
color: #fff;
border: none;
border-radius: 6px;
}

/* REVIEWS */
.review-card {

padding: 20px 0;
}

.review-user {
font-weight: bold;
}

.review-stars {
color: #f59e0b;
}

.review-date {
font-size: 12px;
color: #666;
}
</style>

<!-- ================= PRODUCT ================= -->
<article class="product-page">

  <!-- IMAGE -->
  <div class="product-media">
    {% if product.image %}
      <img src="{{ product.image.url }}" alt="{{ product.name }}">
    {% else %}
      <img src="{% static 'shop/placeholder.png' %}" alt="No image">
    {% endif %}
  </div>

  <!-- INFO -->
  <div class="product-info">

    <h1>{{ product.name }}</h1>

    <p class="small muted">
  Category:
  <a href="{{ product.category.get_absolute_url }}" style="color:#2563eb;font-weight:600;">
    {{ product.category.name }}
  </a>
</p>

    <div class="price-row">
      {% if product.has_offer %}
        <div class="price-big">‚Çπ{{ product.get_display_price }}</div>
        <div class="strike">‚Çπ{{ product.price }}</div>
        <div class="discount-badge">{{ product.discount_percent }}% OFF</div>
      {% else %}
        <div class="price-big">‚Çπ{{ product.price }}</div>
      {% endif %}
    </div>

    <p class="desc">{{ product.description|linebreaksbr }}</p>

    <!-- ===== ADMIN BLOCK ===== -->
    {% if user.is_authenticated and user.is_staff %}
      <p style="color:#b91c1c;font-weight:600;">
        üîí Admin accounts cannot place orders.
      </p>
      <a href="{% url 'shop:product_list' %}" class="btn btn-outline">‚Üê Back</a>

    {% else %}

    <!-- ===== ADD TO CART FORM ===== -->
    <form method="post">
      {% csrf_token %}

  
     <div class="inline-fields">

  <!-- Quantity -->
  <div class="field">
    <label>Quantity</label>
    {{ form.quantity }}
  </div>

  <!-- Size -->
  {% if form.size %}
  <div class="field">
    <label>Size</label>
    {{ form.size }}
  </div>
  {% endif %}

</div>
   
   <div style="display:flex; gap:14px; margin-top:10px; flex-wrap:wrap;">

  <!-- BUY NOW -->
  <button type="submit"
          class="btn btn-primary"
          formaction="{% url 'shop:buy_now' product.id %}"
          formmethod="post">
    üõí Buy Now
  </button>

  <!-- ADD TO CART -->
  <button type="submit"
          class="btn"
          formaction="{% url 'shop:add_to_cart' product.id %}"
          formmethod="post">
    ‚ûï Add to Cart
  </button>

  <!-- BACK -->
  <a href="{% url 'shop:product_list' %}" class="btn btn-outline">
    ‚Üê Back
  </a>

</div>
</form>
      


    {% endif %}

    <!-- ===== PRICE ALERT ===== -->
    <div class="alert-box">
      <button id="priceAlertBtn" class="btn btn-outline">
        üîî Notify me if price drops
      </button>
      <span id="alertStatus" class="small muted"></span>
    </div>

  </div>
</article>

<!-- ================= RECOMMENDATIONS ================= -->
<section class="reco-section">
  <h3>üß† You might also like</h3>

  <div class="reco-grid">
    {% for p in product.category.products.all|slice:":5" %}
      {% if p.id != product.id %}
      <div class="reco-card">

        {% if p.image %}
          <img src="{{ p.image.url }}" alt="{{ p.name }}">
        {% else %}
          <img src="{% static 'shop/placeholder.png' %}" alt="No image">
        {% endif %}

        <div class="reco-name">{{ p.name }}</div>
        <div class="reco-price">‚Çπ{{ p.get_display_price }}</div>

        <a href="{{ p.get_absolute_url }}" class="btn btn-outline">
          View
        </a>

      </div>
      {% endif %}
    {% endfor %}
  </div>
  <!-- ================= COMMENTS ================= -->
<section>
<div class="review-section">

  <h2>Customer reviews</h2>

  <!-- SUMMARY -->
  <div class="review-header">

    <div class="avg-box">
      <h2>{{ avg_rating }} out of 5</h2>

      <div class="avg-stars">
        {% with avg=avg_rating|floatformat:0 %}
          {% for i in "12345"|slice:avg %}‚òÖ{% endfor %}
        {% endwith %}
      </div>

      <p>{{ total_reviews }} global ratings</p>
    </div>

    <div class="review-bars">
     {% for row in rating_rows %}
<div class="bar-row">
  <span>{{ row.star }} star</span>

  <div class="bar">
    <div class="bar-fill" style="width: {{ row.percent }}%;"></div>
  </div>

  <span class="percent">{{ row.percent|floatformat:0 }}%</span>
</div>
{% endfor %}
    </div>

  </div> <!-- ‚úÖ review-header closed -->

  <!-- REVIEW FORM -->
  {% if user.is_authenticated %}
  <form method="post" class="review-form">
  {% csrf_token %}
  <input type="hidden" name="action" value="review">

  <select name="rating" style="position:relative;width:18px;left:175px;top:10px;height:20px;">
    <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Excellent</option>
    <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ Good</option>
    <option value="3">‚òÖ‚òÖ‚òÖ Average</option>
    <option value="2">‚òÖ‚òÖ Poor</option>
    <option value="1">‚òÖ Very Poor</option>
  </select>
   

    <input name="comment_text" placeholder="Write a review..." required style="position:relative;right:25px; top:8px;"></input>
    <button type="submit" style="position:relative;left:10px; top:8px;">Post</button>
  </form>
  {% else %}
    <p>Please login to write a review.</p>
  {% endif %}

  <!-- REVIEWS LIST -->
  {% for comment in comments %}
  <div class="review-card">
    <div class="review-user">{{ comment.user.email }}</div>

    <div class="review-stars">
      {% for star in star_range %}
        {% if star <= comment.rating %}‚òÖ{% endif %}
      {% endfor %}
    </div>
    

    <div class="review-date">
      {{ comment.created_at|date:"M d, Y" }}
    </div>
     {% if user == comment.user %}
      <form method="post" action="{% url 'shop:delete_comment' comment.id %}">
  {% csrf_token %}
  <input type="hidden" name="action" value="delete">
  <button type="submit" style="color:red;border:none;background:none;">
    Delete
  </button>
</form>
    {% endif %}

    <p>{{ comment.text }}</p>
  </div>
  {% empty %}
    <p>No reviews yet.</p>
   
  {% endfor %}
   

</div>
</section>
 
</section>
</section>
<!-- ================= PRICE ALERT SCRIPT ================= -->
<script>
const btn = document.getElementById('priceAlertBtn');
const status = document.getElementById('alertStatus');

const productKey = "price_alert_{{ product.id }}";
const currentPrice = {{ product.get_display_price }};

btn.addEventListener("click", function () {
  // Save alert in browser
  localStorage.setItem(productKey, currentPrice);

  // UI feedback
  status.innerText = "‚úî Price alert saved. We'll notify you if price drops.";

  // Optional: visually disable button
  btn.disabled = true;
  btn.style.opacity = "0.6";
});
</script>

{% endblock %}