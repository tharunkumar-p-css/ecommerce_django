{% extends 'shop/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'shop/product_detail.css' %}">
{% endblock %}

{% block content %}

<!-- ================= PRODUCT ================= -->
<article class="product-page">

  <!-- IMAGE -->
  <div class="product-media">
    {% if product.image %}
      <img src="{{ product.image.url }}" alt="{{ product.name }}">
    {% else %}
      <img src="{% static 'shop/placeholder.png' %}" alt="No image">
    {% endif %}
  </div>

  <!-- INFO -->
  <div class="product-info">

    <h1>{{ product.name }}</h1>

    <p class="small muted">
      Category:
      <a href="{{ product.category.get_absolute_url }}" class="category-link">
        {{ product.category.name }}
      </a>
    </p>

    <div class="price-row">
      {% if product.has_offer %}
        <div class="price-big">‚Çπ{{ product.get_display_price }}</div>
        <div class="strike">‚Çπ{{ product.price }}</div>
        <div class="discount-badge">{{ product.discount_percent }}% OFF</div>
      {% else %}
        <div class="price-big">‚Çπ{{ product.price }}</div>
      {% endif %}
    </div>

    <p class="desc">{{ product.description|linebreaksbr }}</p>

    <!-- ===== ADMIN BLOCK ===== -->
    {% if user.is_authenticated and user.is_staff %}
      <p class="admin-warning">
        üîí Admin accounts cannot place orders.
      </p>
      <a href="{% url 'shop:product_list' %}" class="btn btn-outline">‚Üê Back</a>

    {% else %}

    <!-- ===== ADD TO CART FORM ===== -->
    <form method="post">
      {% csrf_token %}

      <div class="inline-fields">

        <!-- Quantity -->
        <div class="field">
          <label>Quantity</label>
          {{ form.quantity }}
        </div>

        <!-- Size -->
        {% if form.size %}
        <div class="field">
          <label>Size</label>
          {{ form.size }}
        </div>
        {% endif %}

      </div>

      <div class="action-row">

        <!-- BUY NOW -->
        <button type="submit"
                class="btn btn-primary"
                formaction="{% url 'shop:buy_now' product.id %}"
                formmethod="post">
          üõí Buy Now
        </button>

        <!-- ADD TO CART -->
        <button type="submit"
                class="btn"
                formaction="{% url 'shop:add_to_cart' product.id %}"
                formmethod="post">
          ‚ûï Add to Cart
        </button>

        <!-- BACK -->
        <a href="{% url 'shop:product_list' %}" class="btn btn-outline">
          ‚Üê Back
        </a>

      </div>
    </form>

    {% endif %}

    <!-- ===== PRICE ALERT ===== -->
    <div class="alert-box">
      <button id="priceAlertBtn" class="btn btn-outline">
        üîî Notify me if price drops
      </button>
      <span id="alertStatus" class="small muted"></span>
    </div>

  </div>
</article>

<!-- ================= RECOMMENDATIONS ================= -->
<section class="reco-section">
  <h3>üß† You might also like</h3>

  <div class="reco-grid">
    {% for p in product.category.products.all|slice:":5" %}
      {% if p.id != product.id %}
      <div class="reco-card">

        {% if p.image %}
          <img src="{{ p.image.url }}" alt="{{ p.name }}">
        {% else %}
          <img src="{% static 'shop/placeholder.png' %}" alt="No image">
        {% endif %}

        <div class="reco-name">{{ p.name }}</div>
        <div class="reco-price">‚Çπ{{ p.get_display_price }}</div>

        <a href="{{ p.get_absolute_url }}" class="btn btn-outline">
          View
        </a>

      </div>
      {% endif %}
    {% endfor %}
  </div>
</section>

<!-- ================= COMMENTS ================= -->
<section>
  <div class="review-section">

    <h2>Customer reviews</h2>

    <!-- SUMMARY -->
    <div class="review-header">

      <div class="avg-box">
        <h2>{{ avg_rating }} out of 5</h2>

        <div class="avg-stars">
          {% with avg=avg_rating|floatformat:0 %}
            {% for i in "12345"|slice:avg %}‚òÖ{% endfor %}
          {% endwith %}
        </div>

        <p>{{ total_reviews }} global ratings</p>
      </div>

      <div class="review-bars">
        {% for row in rating_rows %}
        <div class="bar-row">
          <span>{{ row.star }} star</span>

          <div class="bar">
            <div class="bar-fill" style="width: {{ row.percent }}%;"></div>
          </div>

          <span class="percent">{{ row.percent|floatformat:0 }}%</span>
        </div>
        {% endfor %}
      </div>

    </div>

    <!-- REVIEW FORM -->
{% if user.is_authenticated %}
<form method="post" class="review-form">
  {% csrf_token %}
  <input type="hidden" name="action" value="review">

  <!-- Write Review + Post -->
  <div class="review-row">
    <input type="text" name="comment_text" placeholder="Write a review..." required>
    <button type="submit">Post</button>
  </div>

  <div class="rating-input">

  <input type="radio" id="star1" name="rating" value="1" required>
  <label for="star1">‚òÖ</label>

  <input type="radio" id="star2" name="rating" value="2">
  <label for="star2">‚òÖ</label>

  <input type="radio" id="star3" name="rating" value="3">
  <label for="star3">‚òÖ</label>

  <input type="radio" id="star4" name="rating" value="4">
  <label for="star4">‚òÖ</label>

  <input type="radio" id="star5" name="rating" value="5">
  <label for="star5">‚òÖ</label>

</div>

</form>
{% else %}
<p>Please login to write a review.</p>
{% endif %}

    <!-- REVIEWS LIST -->
    {% for comment in comments %}
    <div class="review-card">
      <div class="review-user">{{ comment.user.email }}</div>

      <div class="review-stars">
        {% for star in star_range %}
          {% if star <= comment.rating %}‚òÖ{% endif %}
        {% endfor %}
      </div>

      <div class="review-date">
        {{ comment.created_at|date:"M d, Y" }}
      </div>

      {% if user == comment.user %}
        <form method="post" action="{% url 'shop:delete_comment' comment.id %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="delete">
          <button type="submit" class="delete-review-btn">
            Delete
          </button>
        </form>
      {% endif %}

      <p>{{ comment.text }}</p>
    </div>
    {% empty %}
      <p>No reviews yet.</p>
    {% endfor %}

  </div>
</section>

<!-- ================= PRICE ALERT SCRIPT ================= -->
<script>
const btn = document.getElementById('priceAlertBtn');
const status = document.getElementById('alertStatus');

const productKey = "price_alert_{{ product.id }}";
const currentPrice = {{ product.get_display_price }};

btn.addEventListener("click", function () {
  localStorage.setItem(productKey, currentPrice);
  status.innerText = "‚úî Price alert saved. We'll notify you if price drops.";
  btn.disabled = true;
  btn.style.opacity = "0.6";
});
</script>

{% endblock %}