{% extends "shop/base.html" %}
{% load static %}

{% block content %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'shop/product_list.css' %}">
{% endblock %}
<div class="container">

  <!-- ORDER MESSAGE -->
  {% if order_placed %}
    <div class="order-success">
      ‚úÖ Order placed successfully
    </div>
  {% endif %}

  <!-- MOVING OFFER ADS -->
  {% if offer_ads %}
  <div class="offer-wrapper">
    <div class="offer-slider">

      {% for ad in offer_ads %}
      <div class="offer-card">
        <div class="offer-left">
          <span class="offer-badge">üî• LIMITED OFFER</span>
          <h2>{{ ad.title }}</h2>
          <p>{{ ad.subtitle }}</p>
          {% if ad.end_date %}
            <div class="offer-countdown" data-end="{{ ad.end_date|date:'Y-m-d H:i:s' }}"></div>
          {% endif %}
        </div>
        <div class="offer-right">üéÅ</div>
      </div>
      {% endfor %}

      <!-- duplicate for infinite scroll -->
      {% for ad in offer_ads %}
      <div class="offer-card">
        <div class="offer-left">
          <span class="offer-badge">üî• LIMITED OFFER</span>
          <h2>{{ ad.title }}</h2>
          <p>{{ ad.subtitle }}</p>
          {% if ad.end_date %}
            <div class="offer-countdown" data-end="{{ ad.end_date|date:'Y-m-d H:i:s' }}"></div>
          {% endif %}
        </div>
        <div class="offer-right">üéÅ</div>
      </div>
      {% endfor %}

    </div>
  </div>
  {% endif %}

  {% if offers_page %}
    <div class="offers-banner">üî• Showing OFFER products</div>
  {% endif %}

  <!-- HERO -->
  <section class="hero">
    <h1>Drop-dead comfortable products.<br>Built for everyday.</h1>
    <p>Explore latest drops, exclusive deals & handpicked styles.</p>

    <div class="ctas">
      <a href="{% url 'shop:product_list' %}" class="btn">Shop Now</a>
      <a href="?sort=new" class="btn btn-secondary">New Arrivals</a>

      <div class="inline-filter">
        <label>Filter</label>
        <form method="get">
          <select name="sort" onchange="this.form.submit()">
            <option value="">Recommended</option>
            <option value="price_asc">Low to High</option>
            <option value="price_desc">High to Low</option>
            <option value="new">Newest</option>
          </select>
        </form>
      </div>
    </div>
  </section>

  <!-- PRODUCTS -->
  <div class="product-grid">
    {% for product in products %}
    <div class="product-card">

      {% if product.has_offer %}
        <div class="offer-chip">OFFER</div>
      {% endif %}

      {% if forloop.counter|divisibleby:4 %}
        <div class="trending-chip">üî• Trending</div>
      {% endif %}

      {% if product.image %}
        <img src="{{ product.image.url }}" alt="{{ product.name }}">
      {% else %}
        <img src="{% static 'shop/placeholder.png' %}" alt="No image">
      {% endif %}

      <h3>{{ product.name }}</h3>

      <div class="price-row">
        {% if product.has_offer %}
          <span class="price price-offer">‚Çπ{{ product.get_display_price }}</span>
          <span class="old-price">‚Çπ{{ product.price }}</span>
        {% else %}
          <span class="price">‚Çπ{{ product.price }}</span>
        {% endif %}
      </div>

      <a href="{{ product.get_absolute_url }}" class="view-btn">View</a>

    </div>
    {% empty %}
      <p>No products found.</p>
    {% endfor %}
  </div>

</div>


<!-- Countdown Script -->
<script>
document.querySelectorAll('.offer-countdown').forEach(el => {
  const end = new Date(el.dataset.end).getTime();

  function tick(){
    const diff = end - Date.now();

    if(diff <= 0){
      el.innerHTML = "‚è∞ Deal ended";
      return;
    }

    const d = Math.floor(diff / (1000*60*60*24));
    const h = Math.floor((diff / (1000*60*60)) % 24);
    const m = Math.floor((diff / (1000*60)) % 60);

    el.innerHTML = ‚è≥ Ends in ${d}d ${h}h ${m}m;
  }

  tick();
  setInterval(tick, 60000);
});
</script>

{% endblock %}